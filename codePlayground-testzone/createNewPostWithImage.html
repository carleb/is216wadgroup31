<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Firebase storage test</title>

</head>

<body>
    Post text:
    <input type='text' id='textinput'>
    <br/>
    <input type='file' id='photo'>

    <button onclick='createNewPost()'>Create Post</button>


    <button id = "find-me" onclick="geoFindMe()">Show my location</button><br/>
    <p id = "status"></p> 
    <a id = "map-link"></a>

</body>
<script src='https://www.gstatic.com/firebasejs/7.7.0/firebase-app.js'></script>
<script src='https://www.gstatic.com/firebasejs/7.7.0/firebase-storage.js'></script>
<script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>

<script>
  // check if user in login
  
  const firebaseConfig = {
      apiKey: "AIzaSyAX0HnHSqWsEsiD9jIkiPxlf0wQKhPUIr0",
      authDomain: "wadgroup31-e83d0.firebaseapp.com",
      databaseURL: "https://wadgroup31-e83d0-default-rtdb.asia-southeast1.firebasedatabase.app",
      projectId: "wadgroup31-e83d0",
      storageBucket: "wadgroup31-e83d0.appspot.com",
      messagingSenderId: "335704215919",
      appId: "1:335704215919:web:84be6b73640053f4f9d89a",
      measurementId: "G-LB3RXZXQ34"
    };

  firebase.initializeApp(firebaseConfig);
  console.log(firebase)

  myStorage = window.sessionStorage;
  if (myStorage.userID===undefined){
        console.log("Not login")
        // console.log(myStorage)
    }else{
        console.log("Login")
        // console.log(myStorage)
        user_id = myStorage.userID
        // console.log(user_id)
    }

  // function uploadImage(){
  //   const ref= firebase.storage().ref()
  //   const file = document.querySelector("#photo").files[0]
  //   const name = new Date() + "-"+file.name
  //   const metadata = {
  //     contentType:file.type
  //   }
    
  //   textInput = document.getElementById("textinput").value
  //   if(file === undefined){ 
  //     // text only
  //       postMetaData={
  //         "postID":"string",
  //         "postType":"text",
  //         "postText":textInput,
  //         "postedBy": user_id,
  //         "postedOn": new Date(),
  //         "postedAt": "user's current location",
  //         "tagged" : null,
  //         "comments":null,
  //         "like": null,
  //         "shareableURL":"string"
  //     }
  //   }else{
  //     // text and photo
  //       postMetaData = {
  //         "postID":"string",
  //         "postType":"photo",
  //         "photoUrl": ["list of photo url"],
  //         "postText":textInput,
  //         "postedBy": user_id,
  //         "postedOn": new Date(),
  //         "postedAt": "user's current location",
  //         "tagged" : "petID",
  //         "comments":null,
  //         "like": null,
  //         "shareableURL":"string"
  //       }
  //     }
  //   };


  function createNewPost(){
    const file = document.querySelector("#photo").files[0]
    textInput = document.getElementById("textinput").value
    currentLocation="no location"

    function success(position) {
    const latitude  = position.coords.latitude;
    const longitude = position.coords.longitude;
    currentLocation = {latitude:latitude,longitude:longitude} 
    }

    function error() {
      console.log(currentLocation)
    }

    if(!navigator.geolocation) {
      alert('Geolocation is not supported by your browser');
    } else {
      navigator.geolocation.getCurrentPosition(success, error);
    }

    if(textInput == ""){
      alert("text field in blank")
    }else{
      if(file === undefined){
      console.log("Creating Post with textonly")
      createNewPostTextOnly()
    }else{
      console.log("Creating Post with text and picture")
      createNewPostWithPhoto()
    }
  }
    }
    
  function createNewPostWithPhoto() {
    tableName = "post"
    firebaseurl = "https://wadgroup31-e83d0-default-rtdb.asia-southeast1.firebasedatabase.app/";

    url = firebaseurl + tableName + ".json"
    axios.get(url)
        .then((response) => {
            newPostID = response.data.data.length
            console.log(newPostID)
            const ref= firebase.storage().ref()
            const file = document.querySelector("#photo").files[0]
            const name = newPostID + "-"+file.name
            const metadata = {
              contentType:file.type
            }
            
            textInput = document.getElementById("textinput").value
            const task = ref.child("postFiles/"+name).put(file,metadata)
              task
              .then(snapshot => snapshot.ref.getDownloadURL())
              .then(url =>{
                console.log(url)
                url = firebaseurl + tableName + "/data/" + newPostID + ".json"
                axios.put(url, {
                    "postID":newPostID,
                    "postType":"photo",
                    "photoUrl": [url],
                    "postText":textInput,
                    "postedBy": user_id,
                    "postedOn": new Date(),
                    "postedAt": currentLocation,
                    "tagged" : "petID",
                    "comments":null,
                    "like": null,
                    "shareableURL":"string"
                }).then((response) => {
                  console.log(response);
            });
            })
        }, (error) => {
            console.log(error);
            output = error

        });
  }

  function createNewPostTextOnly() {
    tableName = "post"
    firebaseurl = "https://wadgroup31-e83d0-default-rtdb.asia-southeast1.firebasedatabase.app/";
    textInput = document.getElementById("textinput").value
    url = firebaseurl + tableName + ".json"
    axios.get(url)
        .then((response) => {
            newPostID = response.data.data.length
            console.log(newPostID)
            url = firebaseurl + tableName + "/data/" + newPostID + ".json"
            axios.put(url, {
                "postID":newPostID,
                "postType":"text",
                "postText":textInput,
                "postedBy": user_id,
                "postedOn": new Date(),
                "postedAt": currentLocation,
                "tagged" : "petID",
                "comments":null,
                "like": null,
                "shareableURL":"string"
            }).then((response) => {
              console.log(response);
            });
        }, (error) => {
            console.log(error);
            output = error

        });
  }

  function getAllPost(){
    tableName = "post"
    firebaseurl = "https://wadgroup31-e83d0-default-rtdb.asia-southeast1.firebasedatabase.app/";

    url = firebaseurl + tableName + ".json"
    axios.get(url)
        .then((response) => {
            allPostData = response.data.data
            console.log(allPostData)
          }, (error) => {
            console.log(error);
            output = error

        });
  }
</script>

</html>
