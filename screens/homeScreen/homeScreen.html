<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Pet Society</title>
</head>
<!-- CSS only -->
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet"
  integrity="sha384-1BmE4kWBq78iYhFldvKuhfTAU6auU8tT94WrHftjDbrCEXSU1oBoqyl2QvZ6jIW3" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.3.0/font/bootstrap-icons.css">
<link rel='stylesheet' href='homepage.css'>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
<body onload='typeWriter()'>
    <div class='container-fluid bg-light fs-5 py-3' style='text-align: center;display: none;' id='location-check'>
      Please enable your location services and refresh the page to have the best experience on PetSociety :)
    </div>
  <!-- navbar start -->
  <nav class="shadow-sm navbar navbar-expand-lg navbar-light bg-white sticky-top">
    <div class="container-fluid">
      <div class='mx-md-2'>
        <img class='hover-zoom' src='../../img/logo.png' width=80 height=80>
      </div>
      <form class='ms-lg-5'>
        <input class="form-control rounded1 me-2 d-sm-inline d-none" type="search" placeholder="Search" aria-label="Search">
      </form>
      <!-- modal button start -->
      <button  id="post" style='width:200px' class='btn ms-2' data-bs-toggle="modal"
        data-bs-target="#createPost" onclick="fillPost(this.id)"><img class='float-start' width=40 height=40
          src='icons/pencil-square.svg'><span style='white-space:nowrap' class="d-none d-sm-flex font-monospace ms-1 float-start mt-1"
          id='newpost'></span></button>
      <!-- modal button end -->

      <button class="navbar-toggler mx-1 border-0 hover-color " type="button" data-bs-toggle="collapse"
        data-bs-target="#navbarScroll" aria-controls="navbarSupportedContent" aria-expanded="false"
        aria-label="Toggle navigation">
        <span class="navbar-toggler-icon"></span>
      </button>

      <div class="collapse navbar-collapse" id="navbarScroll">
        <ul class="navbar-nav me-auto my-2 my-lg-0 m-lg-auto" style="--bs-scroll-height: 100px;">
          <li id="home" class="nav-item mx-3 hover-color" onclick=fill(this.id)>
            <a class="nav-link active px-3" aria-current="page" href="#"><img src="icons/house-fill.svg" alt="Bootstrap"
                width="32" height="32">
              <span class='d-sm-inline d-md-inline d-lg-none my-auto mx-3 text-dark font-monospace'>Home</span></a>
          </li>
          <li id="chat" class="nav-item mx-3 hover-color" onclick=fill(this.id)>
            <a class="nav-link px-3" href="#"><img src="./icons/chat.svg" alt="Bootstrap" width="32" height="32">
              <span class='d-sm-inline d-md-inline d-lg-none my-auto mx-3 text-dark font-monospace'>Chat</span></a>
          </li>
          <li id="profile" class="nav-item mx-3 hover-color" onclick=fill(this.id)>
            <a class="nav-link px-3" href="#"><img src="./icons/person.svg" alt="Bootstrap" width="32" height="32">
              <span class='d-sm-inline d-md-inline d-lg-none my-auto mx-3 text-dark font-monospace'>Profile</span></a>
          </li>
          <li id="map" class="nav-item mx-3 hover-color" onclick=fill(this.id)>
            <a class="nav-link px-3" href="#"><img src="./icons/pin-map.svg" alt="Bootstrap" width="30" height="30">
              <span class='d-sm-inline d-md-inline d-lg-none my-auto mx-3 text-dark font-monospace'>Nearby
                Pets</span></a>
          </li>
          <li id="logout" class="nav-item mx-3 hover-color" onclick=logout()>
            <a class="nav-link px-3" href="#"><img src="./icons/box-arrow-right.svg" alt="Bootstrap" width="32" height="32">
              <span class='d-sm-inline d-md-inline d-lg-none my-auto mx-3 text-dark font-monospace'>Log Out</span></a>
          </li>
        </ul>
      </div>
    </div>
  </nav>
  <!-- navbar end -->

  <!-- modal start -->
  <div class="modal fade" id="createPost" tabindex="-1" aria-labelledby="exampleModalLabel" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="exampleModalLabel">New Post</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
    
          <!-- form start -->
            <!-- drop files start-->
            <div class="input-group">
              <button type="button" class="btn btn-secondary rounded2 mb-1"> <label id='uploadImageLabel' for="file">Upload an Image</label></button> 
              <input type="file" class="button button-secondary m-2" style="display:none" id="file"
                accept="image/png, image/jpeg, image/heic" name="file" multiple onchange="loadImageDisplay(event)">
            </div>
            <div class='ml-3'>
               <img id="output" class="card-img-top rounded2 shadow" style='max-height:500px; object-fit:cover'>  
            </div>

            <!-- drop files end-->
    
            <!-- post text start -->
            <div class="input-group m-2">
              <textarea placeholder="Post Caption" id="post-text" name="text" type="textbox" class="form-control"></textarea>
            </div>
            <div class="input-group m-2">
              Tag : <input placeholder="Who are you with?" id="post-tag" name="Tag" type="Tag" class="form-control ml-3">
            </div>
    
            <!-- post text end -->
    
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
          <button type="button" class="btn btn-primary" data-bs-dismiss="modal" onclick="createPost()">Post</button>
        </div>
        <!-- form end -->
    
      </div>
    </div>
  </div>
  <!-- modal end -->
  
  
  <div class='container-fluid fadein'>
    <div class='row mx-1'>
       <!-- sidebar start -->
      <div class='col-xl-3 col-md-12 col-sm-12 col-xs-12 mt-3 mt-xl-0 ms-sm-0'> 
        <div id='sideBar'style="max-width:800px;" class="scrollbar p-3 shadow rounded2 themebg  mx-auto stick sidebar">
          <div class='text-center font-monospace fs-5 fw-bold my-auto'>
            Nearby Pets
          </div>
          
          <div id='petsDiv' class='mb-4 rounded2 scrollbar text-center font-monospace mt-4 d-flex d-xl-block'>
          

          </div>
          
        </div>
      </div>
          
          
      
      <!-- sidebar end -->

      <!-- body content start -->
      <div class="col-xl-6 col-md-12 col-sm-12 col-xs-12 body-text ms-sm-0" id='card-list'>
      </div>
      <!-- Chat sidebar -->
      <div class='col-md-3 mt-3 d-xl-inline d-none' id='chatSidebar'>
        <div class='card stick themebg rounded2 p-4 border border-0 shadow font-monospace chatSidebar'>
          <div class="input-group">
            <input type="text" placeholder="Search Chat..." name="" class="form-control search rounded1 ">
            <i class="fa fa-search icon position-absolute" style='right:20px; top:10px'></i>
          </div>
          <hr>
          <div class="card-body contacts_body">
            <ul class="contacts" id=contactList>
              <li class='float-start'>
                <button class="d-flex w-100 rounded2" onClick='showChat(this)'>
                  <div class="img_cont">
                    <img src="https://static.turbosquid.com/Preview/001292/481/WV/_D.jpg" class="rounded-circle user_img">
                  </div>
                  <div class='col-2 d-block user_info my-auto'>
                    <h5 id='friendName' class='text-start'>Gerald</h5>
                  </div>
                  <div class='col-5 my-auto text-end' style='height:38px'>
                    <i class="fa fa-chevron-right mt-2" ></i>
                  </div>   
                </button>
              </li>
           
              <li class='float-start'>
                <button class="d-flex w-100 rounded2" onClick='showChat(this)'>
                  <div class="img_cont">
                    <img src="https://static.turbosquid.com/Preview/001292/481/WV/_D.jpg" class="rounded-circle user_img">
                  </div>
                  <div class='col-2 d-block user_info my-auto'>
                    <h5 id='friendName' class='text-start'>Rou</h5>
                  </div>
                  <div class='col-5 my-auto text-end' style='height:38px'>
                    <i class="fa fa-chevron-right mt-2" ></i>
                  </div>    
                </button>
              </li>
              <li class='float-start'>
                <button class="d-flex w-100 rounded2" onClick='showChat(this)'>
                  <div class="img_cont">
                    <img src="https://static.turbosquid.com/Preview/001292/481/WV/_D.jpg" class="rounded-circle user_img">
                  </div>
                  <div class='col-2 d-block user_info my-auto'>
                    <h5 id='friendName' class='text-start'>Caleb</h5>
                  </div>
                  <div class='col-5 my-auto text-end' style='height:38px'>
                    <i class="fa fa-chevron-right mt-2" ></i>
                  </div>
                </button>
              </li>
            </ul>
          </div>
        </div>
      </div>
    </div>



  </div>



</body>
<!-- JavaScript Bundle with Popper -->
<script src="homepage.js"></script>
<script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
<script src='https://www.gstatic.com/firebasejs/7.7.0/firebase-app.js'></script>
<script src='https://www.gstatic.com/firebasejs/7.7.0/firebase-storage.js'></script>
<!-- firebase api -->
<script src='/firebase-API/createPost.js'></script>
<script src='/firebase-API/connector.js'></script>
<!-- vuejs -->
<script src="https://unpkg.com/vue@next"></script>

<script>

  // get user location
  currentLocation = "no location"

  function success(position) {
    const latitude = position.coords.latitude;
    const longitude = position.coords.longitude;
    currentLocation = { latitude: latitude, longitude: longitude }
  }

  function error() {
    console.log(currentLocation)
  }

  if (!navigator.geolocation) {
    alert('Geolocation is not supported by your browser');
  } else {
    navigator.geolocation.getCurrentPosition(success, error);
  }

  // console.log(currentLocation)
  
  function createPost() {
    const file = document.getElementById("file").files[0]
    createNewPost()
  }
  
  // cardList = document.getElementById('card-list')
 
// update profile ID
profileHTML = `<a class="nav-link px-3" href="/screens/userprofile/user_profile.html?userid=`+window.sessionStorage.userID+`"><img src="./icons/person.svg" alt="Bootstrap" width="32" height="32">
              <span class='d-sm-inline d-md-inline d-lg-none my-auto mx-3 text-dark font-monospace'>Profile</span></a>`
document.getElementById("profile").innerHTML= profileHTML

// cardList.innerHTML = newCardHTML+newCardHTML
allPostId = []
oldData = ""
allPostData=""
allPostIdPictureToUpdate = []
newcomment =true // to load for the first time
function getAllPost() {
    allPostId = []
    allPostIdPictureToUpdate = []

    tableName = "post"
    firebaseurl = "https://wadgroup31-e83d0-default-rtdb.asia-southeast1.firebasedatabase.app/";
    postFeedHTML = ""
    url = firebaseurl + tableName + ".json"
    cardList = document.getElementById('card-list')
    if (!navigator.geolocation) {
      console.log('Geolocation is not supported by your browser');
    } else {
      navigator.geolocation.getCurrentPosition(success, error);
    }

    axios.get(url)
      .then((response) => {
        allPostData = response.data.data
        // console.log(response.data.data)
        allPostData.reverse()
        for(postData of allPostData){
          type = postData.postType
          postText = postData.postText
          postedByID = postData.postedBy
          postedOn = postData.postedOn
          postedAtLocation = postData.postedAt
          nameOfPoseter = postData.nameOfPoseter
          nameOfTagged = postData.nameOfTagged
          distanceFromPost = getDistanceFromLatLonInKm(currentLocation['latitude'], postedAtLocation['longitude'], postedAtLocation['latitude'], currentLocation['longitude'])
          distanceFromPost=Math.round(distanceFromPost * 100) / 100
          if(distanceFromPost == 0){
            distanceFromPost = "Nearby < 0.1km"
          }else if(isNaN(distanceFromPost))
          { distanceFromPost = "No location"}
          else{
            distanceFromPost = distanceFromPost+"km away"
          }
          postId = postData.postID
          postComments(postId)
          allPostIdPictureToUpdate.push([postId,postedByID])
          posterURL = "/screens/userprofile/user_profile.html?userid="+postedByID
          //check if tagged is human or pet
          if(nameOfTagged==''){
            titleHtml =  `<h5><a class='fw-bold text-decoration-none text-dark' href='`+posterURL+`' id='whichPerson'>`+nameOfPoseter+`</a>'s post</h5>`
            profilePictureHTML =`<div class='row' id='profilePicturesOfPost'>
                        <a id='postee' class='col-6'>
                          <img id="postPicture-`+postId+`" style='object-fit:cover;' class='rounded-circle shadow-1-strong ' width='70' height='70'
                            src='/screens/homeScreen/images/sample.png'>
                        </a>
                      </div>`
          }else{
            titleHtml = `<h5><a class='fw-bold text-decoration-none text-dark' href='`+posterURL+`' id='whichPerson'>`+nameOfPoseter+`</a>'s post with <a
                      class='fw-bold text-decoration-none text-dark' id='whichAnimal'>`+nameOfTagged+`</a></h5>`
            profilePictureHTML =`<div class='row' id='profilePicturesOfPost'>
                        <a id='postee' class='col-6'>
                          <img id="postPicture-`+postId+`" style='object-fit:cover;' class='rounded-circle shadow-1-strong ' width='70' height='70'
                          src='/screens/homeScreen/images/sample.png'>
                        </a>
                        <a id='animal' class='col-6'>
                          <img id="postTagPicture-`+postId+`" style='object-fit:cover;' class='rounded-circle shadow-1-strong' width='70' height='70'
                            src='https://firebasestorage.googleapis.com/v0/b/wadgroup31-e83d0.appspot.com/o/postFiles%2F16-Picture1.png?alt=media&token=5b932851-98a7-433f-b889-336e8198fe4b'>
                        </a>
                      </div>`
          }
          if (type == "photo"){
            firstPhotoUrl = postData.photoUrl[0]
            newCardHTML = `<div style="max-width:800px;" id="postid-`+postId+`" class="card shadow border border-0 themebg font-monospace rounded2 py-3 px-md-5 px-sm-4 px-3 mt-xl-4 mt-sm-3 mt-3 mx-auto">
                  <!-- Who shared the post -->
                  <div>
                  `+titleHtml+` 
                  </div>
                  <hr>
                  <!-- Who shared the post end -->
                  <!-- Profile Images, Time, Location Div -->
                  <div class='row mb-3'>
                    <!-- profile images -->
                    <div class='col-6 col-sm-3'>
                      `+profilePictureHTML+`
                    </div>
                    <!-- profile images end -->
                    <!-- time, location -->
                    <div class='col-6 col-sm-9 text-end'>
                      <span class='d-block'><b>`+postedOn+`</b></span>
                      <span class='d-block mt-3'>`+distanceFromPost+`</span>
                    </div>
                    <!-- time, location end -->
                  </div>
                  <!-- Profile Images, Time, Location Div End-->
                  <!-- Image -->
                  <img class="card-img-top rounded2 shadow hover-zoom-img" style='max-height:500px; object-fit:cover' src="`+firstPhotoUrl+`" alt="Card image cap">
                  <!-- Image end -->
                  <div class="card-body">
                    <!-- caption -->
                    <p class="card-text" id='caption'>`+postText+`</p>
                    <!-- caption end-->
                    <!-- number of likes -->
                    <div class='popover__wrapper'>
                      <a class='text-decoration-none text-dark fw-bold' id='numLikes-`+postId+`'></a>
                      <div class="popover__content">
                        <p class="popover__message" id=popLikes-`+postId+`></p>
                      </div>
                    </div>
                    <hr '>
                    <!-- number of likes end-->
                    <!-- like, comment, share -->
                    <div class='row d-flex mt-2'>
                      <div class='col-4'>
                        <a id="heart-`+postId+`" onclick=fillHeart(this.id) style='width:200px' class='btn'><img 
                          class='float-start' width=32 height=32 src='icons/heart.svg'><span id="like-`+postId+`"
                            style='white-space:nowrap' class="font-monospace ms-2 float-start mt-1 d-none d-sm-inline">Like</span></a>
                      </div>
                      <div class='col-4'>
                        <a id='commentButton-`+postId+`' onClick='focusInput(this)' style='width:200px' class='btn'>
                          <img class='float-start' width=32 height=32
                            src='icons/chat-left.svg'><span style='white-space:nowrap'
                            class="font-monospace ms-2 float-start mt-1 d-none d-sm-inline">Comment</span></a>
                      </div>
                      <div class='col-4'>
                        <a id="share" style='width:200px' class='btn'><img class='float-start' width=32 height=32
                            src='icons/share.svg'><span  style='white-space:nowrap'
                            class="font-monospace ms-2 float-start mt-1 d-none d-sm-inline">Share</span></a>
                      </div> 
                      </ul>
                    </div>
                    <hr class='d-none d-sm-flex'>   
                        <div id="commentList-`+postId+`">
                        </div> 
                     
                      
                    <!-- like, comment, share end-->
                  </div>
                  <!-- body end -->
                  <!-- Comment field -->
                  <div class="card-footer py-sm-3 py-0 border-0 themebg">
                    <div class="d-flex ">
                      <img class="rounded-circle shadow-1-strong me-3 d-sm-flex d-none" src="images/sample.png" alt="avatar" width="40"
                        height="40" />
                      <div class=" w-100">
                        <input type='text' onkeypress='onEnter(this, event)' class="form-control rounded1" id="commentField-`+postId+`" rows="1" placeholder="Add Comment...">
                      </div>      
                      <button id=post-`+postId+`  onClick='processComment(this)' type="button" class="hover-zoom btn ms-2"><img src='icons/symmetry-horizontal.svg' width=25></button>
                    </div>
                  </div>
                </div>`
                // postFeedHTML = postFeedHTML + newCardHTML
                getLikesToUpdateHTML(postId)
                
                if(newcomment == true){
                  postComments(postId)
                }
                
          }
                else if (type == "text"){
                  newCardHTML = `<div style="max-width:800px;" id="postid-`+postId+`" class="card shadow border border-0 themebg font-monospace rounded2 py-3 px-md-5 px-sm-4 px-3 mt-xl-4 mt-sm-3 mt-3 mx-auto">
                  <!-- Who shared the post -->
                  <div>
                    `+titleHtml+` 
                  </div>
                  <hr>
                  <!-- Who shared the post end -->
                  <!-- Profile Images, Time, Location Div -->
                  <div class='row mb-3'>
                    <!-- profile images -->
                    <div class='col-6 col-sm-3'>
                      `+profilePictureHTML+`
                    </div>
                    <!-- profile images end -->
                    <!-- time, location -->
                    <div class='col-6 col-sm-9 text-end'>
                      <span class='d-block'><b>`+postedOn+`</b></span>
                      <span class='d-block mt-3'>`+distanceFromPost+`</span>
                    </div>
                    <!-- time, location end -->
                  </div>
                  <!-- Profile Images, Time, Location Div End-->
                  <div class="card-body">
                    <!-- caption -->
                    <p class="card-text" id='caption'>`+postText+`</p>
                    <!-- caption end-->
                  
                    <!-- number of likes end-->
                    <div class='popover__wrapper'>
                      <a class='text-decoration-none text-dark fw-bold' id='numLikes-`+postId+`'></a>
                      <div class="popover__content">
                        <p class="popover__message" id=popLikes-`+postId+`></p>
                      </div>
                    </div>
                    <hr>
                    <!-- number of likes end-->
                    <!-- like, comment, share -->
                    <div class='row d-flex mt-2'>
                      <div class='col-4'>
                        <a id="heart-`+postId+`" onclick=fillHeart(this.id) style='width:200px' class='btn'><img 
                          class='float-start' width=32 height=32 src='icons/heart.svg'><span id="like-`+postId+`"
                            style='white-space:nowrap' class="font-monospace ms-2 float-start mt-1 d-none d-sm-inline">Like</span></a>
                      </div>
                      <div class='col-4'>
                        <a id='commentButton-`+postId+`' onClick='focusInput(this)' style='width:200px' class='btn'>
                          <img class='float-start' width=32 height=32
                            src='icons/chat-left.svg'><span style='white-space:nowrap'
                            class="font-monospace ms-2 float-start mt-1 d-none d-sm-inline">Comment</span></a>
                      </div>
                      <div class='col-4'>
                        <a id="share" style='width:200px' class='btn'><img class='float-start' width=32 height=32
                            src='icons/share.svg'><span  style='white-space:nowrap'
                            class="font-monospace ms-2 float-start mt-1 d-none d-sm-inline">Share</span></a>
                      </div> 
                      </ul>
                    </div>
                    <hr class='d-none d-sm-flex'>   
                        <div id="commentList-`+postId+`">
                        </div> 
                     
                      
                    <!-- like, comment, share end-->
                  </div>
                  <!-- body end -->
                  <!-- Comment field -->
                  <div class="card-footer py-sm-3 py-0 border-0 themebg">
                    <div class="d-flex ">
                      <img class="rounded-circle shadow-1-strong me-3 d-sm-flex d-none" src="images/sample.png" alt="avatar" width="40"
                        height="40" />
                      <div class=" w-100">
                        <input type='text' onkeypress='onEnter(this, event)' class="form-control rounded1" id="commentField-`+postId+`" rows="1" placeholder="Add Comment...">
                      </div>      
                      <button id=post-`+postId+` onClick='processComment(this)' type="button" class="hover-zoom btn ms-2"><img src='icons/symmetry-horizontal.svg' width=25></button>
                    </div>
                  </div>
                </div>`
                }
            postFeedHTML = postFeedHTML + newCardHTML
            getLikesToUpdateHTML(postId)
            if(newcomment == true){
              postComments(postId)
            }
          
        }
        newcomment =false
        if(allPostData.length ==  oldData.length){
          console.log('no changes')
          // if got changes reload
        }else{
          console.log("change detected reloading posts")
          cardList.innerHTML =postFeedHTML
          oldData = allPostData
          for(update of allPostIdPictureToUpdate){
            postID = update[0]
            posterID = update[1]
            updatePosterPicture(posterID,postID)
          }
        }
      }, (error) => {
        console.log(error);
        output = error

      });
  }
  myStorage = window.sessionStorage;
  if (myStorage.userID===undefined){
        console.log("Not login")
        // console.log(myStorage)
        myStorage.redirect = 'fromLoginNoAccount'
        window.location.href = "/screens/welcomeScreen/login.html"; 
    }else{
        console.log("Login")
        // console.log(myStorage)
        user_id = myStorage.userID
        // console.log(user_id)
    }
   
  getAllPost()
  
  var i = 1;                  //  set your counter to 1

  function myLoop() {         //  create a loop function
    setTimeout(function() {   //  call a 3s setTimeout when the loop is called
      getAllPost()  //  your code here
      i++;                    //  increment the counter
      if (i < 100) {           //  if the counter < 10, call the loop function
        myLoop();             //  ..  again which will trigger another 
      }                       //  ..  setTimeout()
    }, 10000)
  }

  myLoop();                   //  start the loop
 
  
  function checkIfUserOnLocation() {         //  create a loop function
    setTimeout(function() {   
      console.log(currentLocation)
      if(currentLocation == "no location"){
        document.getElementById('location-check').style.display='block'
      }
      populateSideBar()
    }, 2000)
  }
  checkIfUserOnLocation()
  const queryString = window.location.search;

  console.log(queryString);
</script>

</html>