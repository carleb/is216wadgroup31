<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Profile Page</title>
</head>
<!-- CSS only -->
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet"
    integrity="sha384-1BmE4kWBq78iYhFldvKuhfTAU6auU8tT94WrHftjDbrCEXSU1oBoqyl2QvZ6jIW3" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.3.0/font/bootstrap-icons.css">
<link rel='stylesheet' href='../homeScreen/homepage.css'>

<link rel='stylesheet' href='profile.css'>

<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">

<body onload="onboarding()">

    <!-- navbar start -->
    <nav class="shadow-sm navbar navbar-expand-lg navbar-light bg-white sticky-top">
        <div class="container-fluid">
            <div class='mx-md-2'>
                <img class='hover-zoom' src='../../img/logo.png' width=80 height=80>
            </div>

            <!-- modal button end -->

            <button class="navbar-toggler mx-1 border-0 hover-color " type="button" data-bs-toggle="collapse"
                data-bs-target="#navbarScroll" aria-controls="navbarSupportedContent" aria-expanded="false"
                aria-label="Toggle navigation">
                <span class="navbar-toggler-icon"></span>
            </button>

            <div class="collapse navbar-collapse" id="navbarScroll">
                <ul class="navbar-nav me-auto my-2 my-lg-0 m-lg-auto" style="--bs-scroll-height: 100px;">
                    <li id="home" class="nav-item mx-3 hover-color" onclick=fill(this.id)>
                        <a class="nav-link px-3" aria-current="page" href="/screens/homeScreen/homeScreen.html"><img src="icons/house-fill.svg"
                                alt="Bootstrap" width="32" height="32">
                            <span
                                class='d-sm-inline d-md-inline d-lg-none my-auto mx-3 text-dark font-monospace'>Home</span></a>
                    </li>
                    <li id="chat" class="nav-item mx-3 hover-color" onclick=fill(this.id)>
                        <a class="nav-link px-3" href="#"><img src="./icons/chat.svg" alt="Bootstrap" width="32"
                                height="32">
                            <span
                                class='d-sm-inline d-md-inline d-lg-none my-auto mx-3 text-dark font-monospace'>Chat</span></a>
                    </li>
                    <li id="profile" class="  nav-item mx-3 hover-color" onclick=fill(this.id)>
                        <a class="nav-link px-3" href="#"><img src="./icons/person.svg" alt="Bootstrap" width="32"
                                height="32">
                            <span
                                class='d-sm-inline d-md-inline d-lg-none my-auto mx-3 text-dark font-monospace'>Profile</span></a>
                    </li>
                    <li id="map" class="nav-item mx-3 hover-color" onclick=fill(this.id)>
                        <a class="nav-link px-3" href="#"><img src="./icons/pin-map.svg" alt="Bootstrap" width="30"
                                height="30">
                            <span class='d-sm-inline d-md-inline d-lg-none my-auto mx-3 text-dark font-monospace'>Nearby
                                Pets</span></a>
                    </li>
                    <li id="settings" class="nav-item mx-3 hover-color" onclick=fill(this.id)>
                        <a class="nav-link px-3" href="#"><img src="./icons/gear.svg" alt="Bootstrap" width="32"
                                height="32">
                            <span
                                class='d-sm-inline d-md-inline d-lg-none my-auto mx-3 text-dark font-monospace'>Settings</span></a>
                    </li>
                </ul>
            </div>

        </div>
    </nav>

    <div class="bg-image" style="height: 435px; background-image: url('img/blank_background.jpeg');">

        <div id='imagebox' class="col col-md-5 mx-auto py-4 text-center">

            <img class="card-img-top rounded" id="profilepic"
                style="border-radius: 25%; max-height:300px; object-fit: cover; width: 450px;" src="/img/male_empty.png"
                alt="Card image cap">


            <div class="card-body">
                <h2 id="profilename" class='card-title'></h2>
                <label id='editProfileButton' for="file-upload" class="custom-file-upload rounded mx-auto" style='display:none;width: 40%'>
                    <i class="fa fa-camera"></i> Edit Profile
                </label>
                <button  id="file-upload" style='width:200px' class='btn ms-3' data-bs-toggle="modal"
                data-bs-target="#createPost" type="file"></button>
            </div>
        </div>

    </div>


    <!-- navigation tabs START-->
    <div id='petdetails'>
        <ul class="nav nav-tabs justify-content-center" id="myTab" role="tablist">
            <li class="nav-item" role="presentation">
                <button class="nav-link active" id="posts-tab" data-bs-toggle="tab" data-bs-target="#posts"
                    type="button" role="tab" aria-controls="posts" aria-selected="true">Posts</button>
            </li>

            <li class="nav-item" role="presentation">
                <button class="nav-link" id="followers-tab" data-bs-toggle="tab" data-bs-target="#followers"
                    type="button" role="tab" aria-controls="followers" aria-selected="false">Followers</button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="about-tab" data-bs-toggle="tab" data-bs-target="#about" type="button"
                    role="tab" aria-controls="following" aria-selected="false">Following</button>
            </li>

            <li class="nav-item" role="presentation">
                <button class="nav-link" id="photos-tab" data-bs-toggle="tab" data-bs-target="#photos" type="button"
                    role="tab" aria-controls="photos" aria-selected="false">Photos</button>
            </li>
        </ul>
    </div>
    <!-- navigation tabs END-->
    
    <div class=" mx-auto" id='card-list'>
        <!-- asdasd -->
    </div>
    <div class="modal fade" id="createPost" tabindex="-1" aria-labelledby="exampleModalLabel" aria-hidden="true">
        <div class="modal-dialog">
          <div class="modal-content">
            <div class="modal-header">
              <h5 class="modal-title" id="exampleModalLabel">Edit Profile Picture</h5>
              <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
        
              <!-- form start -->
                <!-- drop files start-->
                <div class="input-group">
                  <button type="button" class="btn btn-secondary rounded2 mb-1"> <label id='uploadImageLabel' for="file">Upload an Image</label></button> 
                  <input type="file" class="button button-secondary m-2" style="display:none" id="file"
                    accept="image/png, image/jpeg, image/heic" name="file" multiple onchange="loadNewProfilePictureDisplay(event)">
                </div>
                <div class='ml-3'>
                   <img id="output" class="card-img-top rounded2 shadow" style='max-height:500px; object-fit:cover'>  
                </div>
            </div>
            <div class="modal-footer">
              <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
              <button type="button" id='updateProfilePic' style='display:none;' class="btn btn-primary" data-bs-dismiss="modal" onclick="updateProfilePicture()">Update Profile Picture</button>
            </div>
            <!-- form end -->
        
          </div>
        </div>
        
      </div>

</body>
<!-- JavaScript Bundle with Popper -->
<script src="../homeScreen/homepage.js"></script>
<script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
<script src='https://www.gstatic.com/firebasejs/7.7.0/firebase-app.js'></script>
<script src='https://www.gstatic.com/firebasejs/7.7.0/firebase-storage.js'></script>
<!-- firebase api -->
<script src='/firebase-API/createPost.js'></script>
<script src='/firebase-API/connector.js'></script>
<!-- vuejs -->
<script src="https://unpkg.com/vue@next"></script>


<script>
    function loadNewProfilePictureDisplay(event){
        var image = document.getElementById('output');
            image.src = URL.createObjectURL(event.target.files[0]);
        document.getElementById('uploadImageLabel').innerText = 'Change image'
        document.getElementById('updateProfilePic').style.display='Block'
    }


    currentLocation = "no location";
    oldData = "";
    allPostData = "";
    newcomment = true;

    var loadFile = function (event) {
        var image = document.getElementById("profilepic");
        image.src = URL.createObjectURL(event.target.files[0]);
    };


    function success(position) {
        const latitude = position.coords.latitude;
        const longitude = position.coords.longitude;
        currentLocation = { latitude: latitude, longitude: longitude }
    }

    function error() {
        console.log(currentLocation)
    }
    allPostIdPictureToUpdate = []
    allPostId = []
    oldData = ""
    allPostData=""

    function get_user_post_by_id(userid) {
        allPostId = []
        // allPostIdPictureToUpdate = []

        tableName = "post"
        firebaseurl = "https://wadgroup31-e83d0-default-rtdb.asia-southeast1.firebasedatabase.app/";
        postFeedHTML = ""
        url = firebaseurl + tableName + ".json"
        cardList = document.getElementById('card-list')
        if (!navigator.geolocation) {
        console.log('Geolocation is not supported by your browser');
        } else {
        navigator.geolocation.getCurrentPosition(success, error);
        }

    axios.get(url)
      .then((response) => {
        allPostData = response.data.data
        // console.log(response.data.data)
        allPostData.reverse()
        for(postData of allPostData){
            if (postData.postedBy == userid) {
                userPicture = '/screens/homeScreen/images/sample.png'

                console.log(postData)
                type = postData.postType
                postText = postData.postText
                postedByID = postData.postedBy
                postedOn = postData.postedOn
                postedAtLocation = postData.postedAt
                nameOfPoseter = postData.nameOfPoseter
                nameOfTagged = postData.nameOfTagged
                distanceFromPost = getDistanceFromLatLonInKm(currentLocation['latitude'], postedAtLocation['longitude'], postedAtLocation['latitude'], currentLocation['longitude'])
                distanceFromPost=Math.round(distanceFromPost * 100) / 100
                if(distanceFromPost == 0){
                    distanceFromPost = "Nearby < 0.1km"
                }else if(isNaN(distanceFromPost))
                { distanceFromPost = "No location"}
                else{
                    distanceFromPost = distanceFromPost+"km away"
                }
                postId = postData.postID
                postComments(postId)
                allPostIdPictureToUpdate.push([postId,postedByID])

                // postComments(postId)
                // console.log(postedByID)
                // check if no tag
                posterURL = "/screens/userprofile/user_profile.html?userid="+postedByID

                //check if tagged is human or pet
                if(nameOfTagged==''){
                    titleHtml =  `<h5><a class='fw-bold text-decoration-none text-dark' href='`+posterURL+`' id='whichPerson'>`+nameOfPoseter+`</a>'s post</h5>`
                    profilePictureHTML =`<div class='row' id='profilePicturesOfPost'>
                        <a id='postee' class='col-6'>
                          <img id="postPicture-`+postId+`" style='object-fit:cover;' class='rounded-circle shadow-1-strong ' width='70' height='70'
                            src='/screens/homeScreen/images/sample.png'>
                        </a>
                      </div>`
                }else{
                    titleHtml = `<h5><a class='fw-bold text-decoration-none text-dark' href='`+posterURL+`' id='whichPerson'>`+nameOfPoseter+`</a>'s post with <a
                            class='fw-bold text-decoration-none text-dark' id='whichAnimal'>`+nameOfTagged+`</a></h5>`
                    profilePictureHTML =`<div class='row' id='profilePicturesOfPost'>
                        <a id='postee' class='col-6'>
                          <img id="postPicture-`+postId+`" style='object-fit:cover;' class='rounded-circle shadow-1-strong ' width='70' height='70'
                          src='/screens/homeScreen/images/sample.png'>
                        </a>
                        <a id='animal' class='col-6'>
                          <img id="postTagPicture-`+postId+`" style='object-fit:cover;' class='rounded-circle shadow-1-strong' width='70' height='70'
                            src='https://firebasestorage.googleapis.com/v0/b/wadgroup31-e83d0.appspot.com/o/postFiles%2F16-Picture1.png?alt=media&token=5b932851-98a7-433f-b889-336e8198fe4b'>
                        </a>
                      </div>`
                }
                if (type == "photo"){
                    firstPhotoUrl = postData.photoUrl[0]
                    newCardHTML = `<div style="max-width:800px;" id="postid-`+postId+`" class="card shadow border border-0 themebg font-monospace rounded2 py-3 px-md-5 px-sm-4 px-3 mt-xl-4 mt-sm-3 mt-3 mx-auto">
                        <!-- Who shared the post -->
                        <div>
                        `+titleHtml+` 
                        </div>
                        <hr>
                        <!-- Who shared the post end -->
                        <!-- Profile Images, Time, Location Div -->
                        <div class='row mb-3'>
                            <!-- profile images -->
                            <div class='col-6 col-sm-3'>
                                `+profilePictureHTML+`
                            </div>
                            <!-- profile images end -->
                            <!-- time, location -->
                            <div class='col-6 col-sm-9 text-end'>
                            <span class='d-block'><b>`+postedOn+`</b></span>
                            <span class='d-block mt-3'>`+distanceFromPost+`</span>
                            </div>
                            <!-- time, location end -->
                        </div>
                        <!-- Profile Images, Time, Location Div End-->
                        <!-- Image -->
                        <img class="card-img-top rounded2 shadow hover-zoom-img" style='max-height:500px; object-fit:cover' src="`+firstPhotoUrl+`" alt="Card image cap">
                        <!-- Image end -->
                        <div class="card-body">
                            <!-- caption -->
                            <p class="card-text" id='caption'>`+postText+`</p>
                            <!-- caption end-->
                            <!-- number of likes -->
                            <div class='popover__wrapper'>
                            <a class='text-decoration-none text-dark fw-bold' id='numLikes-`+postId+`'></a>
                            <div class="popover__content">
                                <p class="popover__message" id="popLikes-`+postId+`"></p>
                            </div>
                            </div>
                            <hr '>
                            <!-- number of likes end-->
                            <!-- like, comment, share -->
                            <div class='row d-flex mt-2'>
                            <div class='col-4'>
                                <a id="heart-`+postId+`" onclick=fillHeart(this.id) style='width:200px' class='btn'><img 
                                class='float-start' width=32 height=32 src='icons/heart.svg'><span id="like-`+postId+`"
                                    style='white-space:nowrap' class="font-monospace ms-2 float-start mt-1 d-none d-sm-inline">Like</span></a>
                            </div>
                            <div class='col-4'>
                                <a id='commentButton-`+postId+`' onClick='focusInput(this)' style='width:200px' class='btn'>
                                <img class='float-start' width=32 height=32
                                    src='icons/chat-left.svg'><span style='white-space:nowrap'
                                    class="font-monospace ms-2 float-start mt-1 d-none d-sm-inline">Comment</span></a>
                            </div>
                            <div class='col-4'>
                                <a id="share" style='width:200px' class='btn'><img class='float-start' width=32 height=32
                                    src='icons/share.svg'><span  style='white-space:nowrap'
                                    class="font-monospace ms-2 float-start mt-1 d-none d-sm-inline">Share</span></a>
                            </div> 
                            </ul>
                            </div>
                            <hr class='d-none d-sm-flex'>   
                                <div id="commentList-`+postId+`">
                                </div> 
                            
                            
                            <!-- like, comment, share end-->
                        </div>
                        <!-- body end -->
                        <!-- Comment field -->
                        <div class="card-footer py-sm-3 py-0 border-0 themebg">
                            <div class="d-flex ">
                            <img class="rounded-circle shadow-1-strong me-3 d-sm-flex d-none" src="`+userPicture+`" alt="avatar" width="40"
                                height="40" />
                            <div class=" w-100">
                                <input type='text' onkeypress='onEnter(this, event)' class="form-control rounded1" id="commentField-`+postId+`" rows="1" placeholder="Add Comment...">
                            </div>      
                            <button id=post-`+postId+`  onClick='processComment(this)' type="button" class="hover-zoom btn ms-2"><img src='icons/symmetry-horizontal.svg' width=25></button>
                            </div>
                        </div>
                        </div>`
                        postFeedHTML = postFeedHTML + newCardHTML
                        getLikesToUpdateHTML(postId)
                        if(newcomment == true){
                        postComments(postId)
                        }
                        // console.log(postFeedHTML)
                        
                }else if (type == "text"){
                        newCardHTML = `<div style="max-width:800px;" id="postid-`+postId+`" class="card shadow border border-0 themebg font-monospace rounded2 py-3 px-md-5 px-sm-4 px-3 mt-xl-4 mt-sm-3 mt-3 mx-auto">
                        <!-- Who shared the post -->
                        <div>
                            `+titleHtml+` 
                        </div>
                        <hr>
                        <!-- Who shared the post end -->
                        <!-- Profile Images, Time, Location Div -->
                        <div class='row mb-3'>
                            <!-- profile images -->
                            <div class='col-6 col-sm-3'>
                                `+profilePictureHTML+`
                            </div>
                            <!-- profile images end -->
                            <!-- time, location -->
                            <div class='col-6 col-sm-9 text-end'>
                            <span class='d-block'><b>`+postedOn+`</b></span>
                            <span class='d-block mt-3'>`+distanceFromPost+`</span>
                            </div>
                            <!-- time, location end -->
                        </div>
                        <!-- Profile Images, Time, Location Div End-->
                        <div class="card-body">
                            <!-- caption -->
                            <p class="card-text" id='caption'>`+postText+`</p>
                            <!-- caption end-->
                        
                            <!-- number of likes end-->
                            <div class='popover__wrapper'>
                            <a class='text-decoration-none text-dark fw-bold' id='numLikes-`+postId+`'></a>
                            <div class="popover__content">
                                <p class="popover__message" id="popLikes-`+postId+`"></p>
                            </div>
                            </div>
                            <hr>
                            <!-- number of likes end-->
                            <!-- like, comment, share -->
                            <div class='row d-flex mt-2'>
                            <div class='col-4'>
                                <a id="heart-`+postId+`" onclick=fillHeart(this.id) style='width:200px' class='btn'><img 
                                class='float-start' width=32 height=32 src='icons/heart.svg'><span id="like-`+postId+`"
                                    style='white-space:nowrap' class="font-monospace ms-2 float-start mt-1 d-none d-sm-inline">Like</span></a>
                            </div>
                            <div class='col-4'>
                                <a id='commentButton-`+postId+`' onClick='focusInput(this)' style='width:200px' class='btn'>
                                <img class='float-start' width=32 height=32
                                    src='icons/chat-left.svg'><span style='white-space:nowrap'
                                    class="font-monospace ms-2 float-start mt-1 d-none d-sm-inline">Comment</span></a>
                            </div>
                            <div class='col-4'>
                                <a id="share" style='width:200px' class='btn'><img class='float-start' width=32 height=32
                                    src='icons/share.svg'><span  style='white-space:nowrap'
                                    class="font-monospace ms-2 float-start mt-1 d-none d-sm-inline">Share</span></a>
                            </div> 
                            </ul>
                            </div>
                            <hr class='d-none d-sm-flex'>   
                                <div id="commentList-`+postId+`">
                                </div> 
                            
                            
                            <!-- like, comment, share end-->
                        </div>
                        <!-- body end -->
                        <!-- Comment field -->
                        <div class="card-footer py-sm-3 py-0 border-0 themebg">
                            <div class="d-flex ">
                            <img class="rounded-circle shadow-1-strong me-3 d-sm-flex d-none" src="`+userPicture+`" alt="avatar" width="40"
                                height="40" />
                            <div class=" w-100">
                                <input type='text' onkeypress='onEnter(this, event)' class="form-control rounded1" id="commentField-`+postId+`" rows="1" placeholder="Add Comment...">
                            </div>      
                            <button id=post-`+postId+` onClick='processComment(this)' type="button" class="hover-zoom btn ms-2"><img src='icons/symmetry-horizontal.svg' width=25></button>
                            </div>
                        </div>
                        </div>`
                          postFeedHTML = postFeedHTML + newCardHTML
                        //   console.log(postFeedHTML)

                        }
                    getLikesToUpdateHTML(postId)
                    if(newcomment == true){
                    postComments(postId)
                    }
                
                }
                // console.log(postFeedHTML)
                
        }

        document.getElementById('card-list').innerHTML=postFeedHTML

                newcomment =false
                if(allPostData.length ==  oldData.length){
                    console.log('no changes')
                    console.log("Why 3 tines")
                }else{
                    console.log("change detected reloading posts")
                    document.getElementById('card-list').innerHTML=postFeedHTML
                    oldData = allPostData
                    console.log("asidjosa JDIOSAJ ")
                    console.log(allPostIdPictureToUpdate)
                    for(update of allPostIdPictureToUpdate){
                        postID = update[0]
                        posterID = update[1]
                        console.log("RUANSDN SAIOD ")
                        updatePosterPicture(posterID,postID)
                    }
                }
      }, (error) => {
        console.log(error);
        output = error

      });
    }


    function get_user_details(userid) {
        tableName = "userProfile"
        firebaseurl = "https://wadgroup31-e83d0-default-rtdb.asia-southeast1.firebasedatabase.app/";
        url = firebaseurl + tableName + ".json";
        // cardList = document.getElementById('card-list');
        axios.get(url)
            .then((response) => {
                allprofiles = response.data.data
                the_user = allprofiles[userid]
                console.log(the_user)
                user_name = the_user.name
                document.getElementById('profilename').innerText = user_name;
                if (the_user.hasOwnProperty("profilePictureUrl")) {

                }
                else {
                    if (the_user.gender == 'Female') {
                        document.getElementById('profilepic').src = "img/female_empty.jpeg"

                    }
                }


            }, (error) => {
                console.log(error);
            });

    }

    function onboarding() {
        // start location setting
        if (!navigator.geolocation) {
            alert('Geolocation is not supported by your browser');
        } else {
            navigator.geolocation.getCurrentPosition(success, error);
        }

        // start session manager
        myStorage = window.sessionStorage;
        if (myStorage.userID === undefined) {
            console.log("Not login")
            // console.log(myStorage)
            myStorage.redirect = 'fromLoginNoAccount'
            window.location.href = "/screens/welcomeScreen/login.html";
        } else {
            console.log("Login")
            // console.log(myStorage)
            my_user_id = myStorage.userID
        }

        // start profile identification
        const queryString = window.location.search;
        // console.log(queryString.split("?")[1].split("=")[1])
        if (queryString == "") {
            console.log("viewing my own profile:", my_user_id)
            document.getElementById('editProfileButton').style.display='block'
            get_user_details(my_user_id)
            get_user_post_by_id(my_user_id)
            getCurrentProfilePicture(my_user_id)

        }
        else if (queryString.split("?")[1].split("=")[1] == my_user_id) {
            console.log("viewing my own profile:", my_user_id)
            document.getElementById('editProfileButton').style.display='block'
            get_user_details(my_user_id)
            get_user_post_by_id(my_user_id)
            getCurrentProfilePicture(my_user_id)
        }
        else {
            // console.log(queryString);
            userid = queryString.split("?")[1].split("=")[1]
            console.log(typeof (userid))
            console.log("viewing other people profile:", userid)
            get_user_details(userid)
            get_user_post_by_id(userid)
            getCurrentProfilePicture(userid)


        }
    }


</script>

</html>