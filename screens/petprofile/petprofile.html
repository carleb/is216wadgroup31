<!doctype html>
<html lang="en">
  <head>
    <!-- Required meta tags -->
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-1BmE4kWBq78iYhFldvKuhfTAU6auU8tT94WrHftjDbrCEXSU1oBoqyl2QvZ6jIW3" crossorigin="anonymous">
    <link rel='stylesheet' href="petprofile.css">
    <script src='/screens/homeScreen/homepage.js'></script>
    <title>Pet Profile</title>
  </head>
  <body id='petroot' onload='onboarding()'>

    <!-- navbar start -->
    <nav class="shadow-sm navbar navbar-expand-lg navbar-light bg-white sticky-top">
      <div class="container-fluid">
        <div class='mx-md-2'>
          <img class='hover-zoom' src='/img/petsoc.png' width=80 height=80>
        </div>
        <form class='ms-lg-5'>
          <input class="form-control rounded1 me-2 d-sm-inline d-none" type="search" placeholder="Search" aria-label="Search">
        </form>
        <!-- modal button start -->
        <button onmouseover='typeWriter()' id="post" style='width:200px' class='btn' data-bs-toggle="modal"
          data-bs-target="#createPost" onclick="fillPost(this.id)"><img class='float-start' width=40 height=40
            src='icons/pencil-square.svg'><span style='white-space:nowrap' class="font-monospace ms-2 float-start mt-1"
            id='newpost'></span></button>
        <!-- modal button end -->
  
        <button class="navbar-toggler mx-1 border-0 hover-color " type="button" data-bs-toggle="collapse"
          data-bs-target="#navbarScroll" aria-controls="navbarSupportedContent" aria-expanded="false"
          aria-label="Toggle navigation">
          <span class="navbar-toggler-icon"></span>
        </button>
  
        <div class="collapse navbar-collapse" id="navbarScroll">
          <ul class="navbar-nav me-auto my-2 my-lg-0 m-lg-auto" style="--bs-scroll-height: 100px;">
            <li id="home" class="nav-item mx-3 hover-color" onclick=fill(this.id)>
              <a class="nav-link active px-3" aria-current="page" href="#"><img src="icons/house-fill.svg" alt="Bootstrap"
                  width="32" height="32">
                <span class='d-sm-inline d-md-inline d-lg-none my-auto mx-3 text-dark font-monospace'>Home</span></a>
            </li>
            <li id="chat" class="nav-item mx-3 hover-color" onclick=fill(this.id)>
              <a class="nav-link px-3" href="#"><img src="./icons/chat.svg" alt="Bootstrap" width="32" height="32">
                <span class='d-sm-inline d-md-inline d-lg-none my-auto mx-3 text-dark font-monospace'>Chat</span></a>
            </li>
            <li id="profile" class="nav-item mx-3 hover-color" onclick=fill(this.id)>
              <a class="nav-link px-3" href="#"><img src="./icons/person.svg" alt="Bootstrap" width="32" height="32">
                <span class='d-sm-inline d-md-inline d-lg-none my-auto mx-3 text-dark font-monospace'>Profile</span></a>
            </li>
            <li id="map" class="nav-item mx-3 hover-color" onclick=fill(this.id)>
              <a class="nav-link px-3" href="#"><img src="./icons/pin-map.svg" alt="Bootstrap" width="30" height="30">
                <span class='d-sm-inline d-md-inline d-lg-none my-auto mx-3 text-dark font-monospace'>Nearby
                  Pets</span></a>
            </li>
            <li id="settings" class="nav-item mx-3 hover-color" onclick=fill(this.id)>
              <a class="nav-link px-3" href="#"><img src="./icons/gear.svg" alt="Bootstrap" width="32" height="32">
                <span class='d-sm-inline d-md-inline d-lg-none my-auto mx-3 text-dark font-monospace'>Settings</span></a>
            </li>
          </ul>
        </div>
  
      </div>
    </nav>
    <!-- navbar end -->

    <!-- top box -->
    <div id="topbox" class="py-3 px-3">
        <div class='row position-relative'>
            
            

            <div id='livedetails' class='card col-md-3 position-absolute bottom-0 start-0 px-0'>
            
                <div class="card-body">
                    <p class='fw-bold mb-0' style='font-size: medium;'>
                        Last Seen At
                    </p>
                    <p id='lastseenaddress' class='fw-bold mb-0'>
                        Address
                    </p>
                    <p id='lastseentime' class='fw-bold mb-0' style='font-size: larger;'>
                        Lastseentime
                    </p>
                    <p class="card-text" style="font-size: small;">
                        To update his last seen, add a new post!
                    </p>
                </div>
                
            </div>


            <div id='imagebox' class="col col-md-5 mx-auto text-center">
                <img id='petimg' class="card-img-top rounded2" 
                style="max-height:300px; max-width:500px; object-fit:cover" 
                src="..." 
                alt="Card image cap">
                <div class="card-body">
                    <h5 id='petName' class='card-title'>
                        Somecat
                    </h5>
                    <button id='follow_or_unfollow' type="button" class="btn btn-outline-secondary" onclick="followandunfollow()">Follow </button>
                </div>

            </div>

            

            
            
        </div>


    </div>

    <!-- bottom box START-->
    <div id="bottombox">
        <!-- navigation tabs START-->
        <div id='petdetails'>
            <ul class="nav nav-tabs justify-content-center" id="myTab" role="tablist">
                <li class="nav-item" role="presentation">
                  <button class="nav-link active" id="about-tab" data-bs-toggle="tab" data-bs-target="#about" type="button" role="tab" aria-controls="about" aria-selected="true">About</button>
                </li>
                <li class="nav-item" role="presentation">
                  <button class="nav-link" id="followers-tab" data-bs-toggle="tab" data-bs-target="#followers" type="button" role="tab" aria-controls="followers" aria-selected="false">Followers</button>
                </li>
                <li class="nav-item" role="presentation">
                  <button class="nav-link" id="posts-tab" data-bs-toggle="tab" data-bs-target="#posts" type="button" role="tab" aria-controls="posts" aria-selected="false">Posts</button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="photos-tab" data-bs-toggle="tab" data-bs-target="#photos" type="button" role="tab" aria-controls="photos" aria-selected="false">Photos</button>
                  </li>
              </ul>
              <!-- navigation tabs END-->

              <!-- tabs content START-->
              <div class="tab-content" id="myTabContent">

                <!-- about tab content START-->
                <div class="tab-pane fade show active" id="about" role="tabpanel" aria-labelledby="about-tab">
                    <!-- top box of about content START-->
                    <div class='row' style='height: 300px;'>
                        <div id='aboutdetails' class="card col-md">
                            <div class="card-body">
                                <p id='founded'></p>

                                <p id='founder'></p>
                                
                                <p id='breed'></p>
                                
                                <p id='gender'></p>
                                
                                
                                <h5>MORE DETAILS</h5>
                                <p id='moredetails'>No extra details for this pet yet</p>
                            </div>
                        </div>
    
                        <div id='feederdetails'class="card col-md" >
                            <div class="card-body">
                              <h5 class="card-title">Feeder Information:</h5>
                              <p id='feederinfo' class="card-text">
                                <li></li>
                              </p>
                              <p id='availdays 'class="card-text"> Looking for feeders for: </p>
                                
                              <button id='feederapply' type="button" class="btn btn-outline-secondary">Apply to be a feeder</button>
                            </div>
                        </div>
                    </div>
                    <!-- top box of about content END-->

                    <!-- bottom of about content(location api) START-->
                    <div id='locationbox' class='row' >
                        <div class='container-fluid border-primary border' style='height: 300px; width:100%; background-color: rgb(165, 165, 165);'>
                                <p>GOOGLE API TO SHOW WHERE IS THE LAST SEEN AND YOU</p>
                        </div>


                    </div>
                    <!-- bottom of about content(location api) END -->
                    
                </div>
                <!-- about tab content END-->

                <!-- followers tab content START-->
                <div class="tab-pane fade" id="followers" role="tabpanel" aria-labelledby="followers-tab">
                  <div class="row row-cols-1 row-cols-md-4 my-3 mx-3 g-4">
                    <div class="col">
                      <div class="card">
                        <img src="..." class="card-img-top" alt="...">
                        <div class="card-body">
                          <h5 class="card-title">Card title</h5>
                        </div>
                      </div>
                    </div>
                    <div class="col">
                      <div class="card">
                        <img src="..." class="card-img-top" alt="...">
                        <div class="card-body">
                          <h5 class="card-title">Card title</h5>
                        </div>
                      </div>
                    </div>
                    <div class="col">
                      <div class="card">
                        <img src="..." class="card-img-top" alt="...">
                        <div class="card-body">
                          <h5 class="card-title">Follower</h5>
                        </div>
                      </div>
                    </div>
                    <div class="col">
                      <div class="card">
                        <img src="..." class="card-img-top" alt="...">
                        <div class="card-body">
                          <h5 class="card-title">Follower</h5>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
                <!-- followers tab content END-->

                <!-- posts tab content START-->
                <div class="tab-pane fade" id="posts" role="tabpanel" aria-labelledby="posts-tab">
                    box
                    pepega
                </div>
                <!-- posts tab content END-->

                <!-- photos tab content START-->
                <div class="tab-pane fade" id="photos" role="tabpanel" aria-labelledby="photos-tab">
                      <!-- Section: Images -->
  <section class="">
    <div class="row">
      <div class="col-lg-4 col-md-12 mb-4 mb-lg-0">
        <div
          class="bg-image hover-overlay ripple shadow-1-strong rounded"
          data-ripple-color="light"
        >
          <img
            src="https://mdbootstrap.com/img/screens/yt/screen-video-1.jpg"
            class="w-100"
          />
          <a href="#!" data-mdb-toggle="modal" data-mdb-target="#exampleModal1">
            <div class="mask" style="background-color: rgba(251, 251, 251, 0.2);"></div>
          </a>
        </div>
      </div>

      <div class="col-lg-4 mb-4 mb-lg-0">
        <div
          class="bg-image hover-overlay ripple shadow-1-strong rounded"
          data-ripple-color="light"
        >
          <img
            src="https://mdbootstrap.com/img/screens/yt/screen-video-2.jpg"
            class="w-100"
          />
          <a href="#!" data-mdb-toggle="modal" data-mdb-target="#exampleModal2">
            <div class="mask" style="background-color: rgba(251, 251, 251, 0.2);"></div>
          </a>
        </div>
      </div>

      <div class="col-lg-4 mb-4 mb-lg-0">
        <div
          class="bg-image hover-overlay ripple shadow-1-strong rounded"
          data-ripple-color="light"
        >
          <img
            src="https://mdbootstrap.com/img/screens/yt/screen-video-3.jpg"
            class="w-100"
          />
          <a href="#!" data-mdb-toggle="modal" data-mdb-target="#exampleModal3">
            <div class="mask" style="background-color: rgba(251, 251, 251, 0.2);"></div>
          </a>
        </div>
      </div>
    </div>
  </section>
  <!-- Section: Images -->
                </div>
                <!-- photos tab content END-->
              </div>
              <!-- tabs content END-->

        </div>
    </div>
    <!-- bottom box END-->








    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-ka7Sk0Gln4gmtz2MlQnikT1wXgYsOg+OMhuP+IlRH9sENBO0LRn5q+8nbTov4+1p" crossorigin="anonymous"></script>

    <!-- Option 2: Separate Popper and Bootstrap JS -->
    <!--
    <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.10.2/dist/umd/popper.min.js" integrity="sha384-7+zCNj/IqJ95wo16oMtfsKbZ9ccEh31eOz1HGyDuCQ6wgnyJNSYdrPa03rtR1zdB" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.min.js" integrity="sha384-QJHtvGhmr9XOIpI6YVutG+2QOK9T+ZnN4kzFN1RtK3zEFEIsxhlmWl5/YESvpZ13" crossorigin="anonymous"></script>
    -->
    
  </body>
<script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
<script src='https://www.gstatic.com/firebasejs/7.7.0/firebase-app.js'></script>
<script src='https://www.gstatic.com/firebasejs/7.7.0/firebase-storage.js'></script>
<!-- vuejs -->
<script src="https://unpkg.com/vue@next"></script>
<script src='/firebase-API/connector.js'></script>


<script>

  //get petID from url
    console.log(window.location.href)
    var url_string = window.location.href; //window.location.href
    var url = new URL(url_string);
    var petID = parseInt(url.searchParams.get("petID"));
    //get petID from url
    console.log("Pet loaded ",petID);
    getPetByID(petID);
    //run getpetID
    
    

    function getPetByID(petID) {
    // userID= toString(userID)
    tableName = "petProfile"
    firebaseurl = "https://wadgroup31-e83d0-default-rtdb.asia-southeast1.firebasedatabase.app/";
    url = firebaseurl + tableName + "/data/" + petID + ".json"
    output = null
    console.log(url)
    axios.get(url)
        .then((response) => {
            output = response.data
            console.log(output)
            petName = output.petName;
            console.log("pet page for: ",petName);
            petPictureUrl = output.petPictureUrl;
            breed = output.breed;
            foundedDate = output.foundedDate;
            founder = output.founderName;
            pet_gender = output.gender;
            latitude = output.lastSeenLocation.latitude;
            longitude = output.lastSeenLocation.longitude;
            details1 = output.profileDetails.detailTitle1;
            details2 = output.profileDetails.detailTitle2;
            var detailstr = 'No extra details for this pet yet'
            if (details1 != null){
              detailstr = `<li>${details1}</li>`;
            }
            if (details1 != null){
              detailstr += `<li>${details2}</li>`;
            }
            document.getElementById('moredetails').innerHTML = detailstr;
            document.getElementById('founded').innerHTML='<b>Founded on: </b>'+foundedDate;
            document.getElementById('founder').innerHTML='<b>Founder: </b>'+founder;
            document.getElementById('petName').innerText=petName;
            document.getElementById('gender').innerHTML='<b>Gender: </b>'+pet_gender;
            document.getElementById('petimg').src=petPictureUrl;
            document.getElementById('breed').innerHTML='<b> Breed: </b>'+breed;
            //document.getElementById('lastseenaddress').innerText=lastSeenLocation;
            document.getElementById('feederapply').innerHTML=`<b>Apply to be a feeder for ${petName}</b>`;
            
        }, 
        (error) => {
            console.log(error);
            output = error
            
        });}
    
    //reverse latitude and longtitude to address
    function getReverseGeocodingData(lat, lng) {
    var latlng = new google.maps.LatLng(lat, lng);
    // This is making the Geocode request
    var geocoder = new google.maps.Geocoder();
    geocoder.geocode({ 'latLng': latlng }, function (results, status) {
        if (status !== google.maps.GeocoderStatus.OK) {
            alert(status);
        }
        // This is checking to see if the Geoeode Status is OK before proceeding
        if (status == google.maps.GeocoderStatus.OK) {
            console.log(results);
            var address = (results[0].formatted_address);
        }
    });
}

function followandunfollow() {

let follow_action = document.getElementById('follow_or_unfollow').innerText;


let my_user_id = parseInt(myStorage.userID);

console.log('current UserID: ',my_user_id);

//const queryString = window.location.search;
//let the_user = parseInt(queryString.split("?")[1].split("=")[1])

tableName = "userProfile"
firebaseurl = "https://wadgroup31-e83d0-default-rtdb.asia-southeast1.firebasedatabase.app/";
url = firebaseurl + tableName + ".json";
axios.get(url)
    .then((response) => {
        allprofiles = response.data.data;
        my_details = allprofiles[my_user_id];
        //user_details = allprofiles[the_user]

        console.log('my details ',my_details.ProfileDetails);
        //console.log(user_details.ProfileDetails)
        let url2 = firebaseurl + tableName + "/data/" + my_user_id + '/ProfileDetails/' + ".json";
      
        //followedByUsers = my_details.ProfileDetails.followedByUsers;

        if (follow_action == "Follow") {
            let followingPet = [];
            //let followedByUsers = [];
            // ME

            if (my_details.ProfileDetails == undefined || my_details.ProfileDetails.followingPet == undefined) {
                //Create followingPet in profiledetails with changes made to following pet
                followingPet = [petID];
            }
            else {
                //add user into your following user list
                my_details.ProfileDetails.followingPet.push(petID);
                followingPet = my_details.ProfileDetails.followingPet
            }

            if (my_details.ProfileDetails == undefined || (my_details.ProfileDetails.followingUsers == undefined && my_details.ProfileDetails.followedByUsers == undefined)) {
                axios.put(url2, {
                    "followingUsers": null,
                    "followedByUsers": null,
                    "followingPet": followingPet
                },)
                    .then(function (response) {
                        console.log("Updated my followingpet successfully");
                    })
            }
            else if(my_details.ProfileDetails.followingUsers == undefined){
              followedByUsers = my_details.ProfileDetails.followedByUsers;
              axios.put(url2, {
                    "followingUsers": null,
                    "followedByUsers": followedByUsers,
                    "followingPet": followingPet
                })
                    .then(function (response) {
                        console.log("Updated my followingpet successfully");
                    })
            }
            else if(my_details.ProfileDetails.followedByUsers == undefined){
              followingByUsers = my_details.ProfileDetails.followingUsers;
              axios.put(url2, {
                    "followingUsers": followingUsers,
                    "followedByUsers": null,
                    "followingPet": followingPet
                })
                    .then(function (response) {
                        console.log("Updated my followingpet successfully");
                    })
            }

            else { 
            followingUsers = my_details.ProfileDetails.followingUsers;
            followedByUsers = my_details.ProfileDetails.followedByUsers;
            axios.put(url2, {
                    "followingUsers": followingUsers,
                    "followedByUsers": followedByUsers,
                    "followingPet": followingPet
            })
                .then(function (response) {
                    console.log("Updated my following pet successfully");
                })
            }

            document.getElementById('follow_or_unfollow').innerHTML = `<i class="fa fa-user"></i> Following`;
            // document.getElementById('follow_or_unfollow').innerText = "Following"
            document.getElementById('follow_or_unfollow').style.backgroundColor = "#E37383";
        }


        if (follow_action.trim() == "Following") {
            console.log(follow_action);
            //let followingUsers = my_details.ProfileDetails.followingUsers;
            //let followedByUsers = user_details.ProfileDetails.followedByUsers;
            // ME
            //remove pet from your following pet list
            followingPet = my_details.ProfileDetails.followingPet;
            const my_index = my_details.ProfileDetails.followingPet.indexOf(petID);
            if (my_index > -1) {
                followingPet.splice(my_index, 1);

            }

            if (my_details.ProfileDetails == undefined || (my_details.ProfileDetails.followingUsers == undefined && my_details.ProfileDetails.followedByUsers == undefined)) {
                axios.put(url2, {
                    "followingUsers": null,
                    "followedByUsers": null,
                    "followingPet": followingPet
                },)
                    .then(function (response) {
                        console.log("Removed pet from my following pet successfully");
                    })
            }
            else if(my_details.ProfileDetails.followingUsers == undefined){
              followedByUsers = my_details.ProfileDetails.followedByUsers;
              axios.put(url2, {
                    "followingUsers": null,
                    "followedByUsers": followedByUsers,
                    "followingPet": followingPet
                })
                    .then(function (response) {
                        console.log("Removed pet from my following pet successfully");
                    })
            }
            else if(my_details.ProfileDetails.followedByUsers == undefined){
              followingByUsers = my_details.ProfileDetails.followingUsers;
              axios.put(url2, {
                    "followingUsers": followingUsers,
                    "followedByUsers": null,
                    "followingPet": followingPet
                })
                    .then(function (response) {
                        console.log("Removed pet from my following pet successfully");
                    })
            }

            else { 
            followingUsers = my_details.ProfileDetails.followingUsers;
            followedByUsers = my_details.ProfileDetails.followedByUsers;
            axios.put(url2, {
                    "followingUsers": followingUsers,
                    "followedByUsers": followedByUsers,
                    "followingPet": followingPet
            })
                .then(function (response) {
                    console.log("Removed pet from my following pet successfully");
                })
            }

            document.getElementById('follow_or_unfollow').innerHTML = `Follow`;
            document.getElementById('follow_or_unfollow').style.backgroundColor = "";

        }


    })
}

function get_user_details(petid, me) {
        console.log('get user detail function is running');
        tableName = "userProfile"
        firebaseurl = "https://wadgroup31-e83d0-default-rtdb.asia-southeast1.firebasedatabase.app/";
        url = firebaseurl + tableName + ".json";
        // cardList = document.getElementById('card-list');
        axios.get(url)
            .then((response) => {
                allprofiles = response.data.data
                me_details = allprofiles[me]
                // followings = me_details.ProfileDetails['followingUsers']
                // console.log(followings);
                if (me_details.ProfileDetails == undefined || me_details.ProfileDetails.followingPet == undefined) {
                    //Create followinguders in profiledetails with changes made to following user
                    document.getElementById('follow_or_unfollow').innerHTML = `<i class="fa fa-user"></i> Follow`;
                }
                else {
                    followings = me_details.ProfileDetails.followingPet;
                    console.log('Your followings: ',followings);
                    if (followings.includes(parseInt(petID))) {
                        document.getElementById('follow_or_unfollow').innerHTML = `<i class="fa fa-user"></i> Following`;
                        // document.getElementById('follow_or_unfollow').innerText = "Following"
                        document.getElementById('follow_or_unfollow').style.backgroundColor = "#E37383";

                    }

                }


            }, (error) => {
                console.log(error);
            });

    }

    function onboarding() {
        console.log('running onboarding function')
        // start session manager
        myStorage = window.sessionStorage;
        if (myStorage.userID === undefined) {
            console.log("Not login")
            // console.log(myStorage)
            myStorage.redirect = 'fromLoginNoAccount'
            window.location.href = "/screens/welcomeScreen/login.html";
        } else {
            console.log("Login")
            // console.log(myStorage)
            my_user_id = myStorage.userID
        }

        // start profile identification
        //const queryString = window.location.search;
        // console.log(queryString.split("?")[1].split("=")[1])
        
            // console.log(queryString);
            //userid = queryString.split("?")[1].split("=")[1]
            //console.log(typeof (userid))
        console.log('Your user ID: ',my_user_id);

        get_user_details(petID, my_user_id)

        //document.getElementById('follow_or_unfollow').style.display = 'block'
            //get_user_post_by_id(userid)
        
    }
</script>
</html>